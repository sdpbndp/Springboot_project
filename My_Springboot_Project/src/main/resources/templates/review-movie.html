<!DOCTYPE html>
<h2 style="text-align:center">Review of Movies</h2>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />

<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>-->
<!--<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />-->
<!--<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" />-->
<!--<script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.js"></script>-->
<!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>-->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>-->
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />-->
<style type="text/css">
    .bootstrap-select:not([class*="col-"]):not([class*="form-control"]):not(.input-group-btn) {
        width: 100%;
    }
</style>

<body>
    <div class="container">
        <div class="row main">
            <div class="main-login main-center">
                <div class="alert" id="response-message">
                </div>
                <form id="register_form" name="add_movie_details">
                    <div class="form-group">
                        <div class="cols-sm-10">
                            <label class="cols-sm-2 control-label">Genre:</label>
                            <div class="cols-sm-100 " id="genress">
                                <select class="form-control" placeholder="Genres" name="genres" id="genres" onchange="checkError('genres', 'error_genres');">
                                    <option value="">Please Select a Genre</option>
                                </select>
                            </div>
                        </div>
                        <span class="help-block">Select one or multiple genres</span>
                        <span id="error_genres" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <div class="cols-sm-10">
                            <label class="cols-sm-2 control-label">Language:</label>
                            <div class="cols-sm-100 " id="Language">
                                <select class="form-control" id="languages" name="languages"
                                        onchange="checkError('languages', 'error_language')">
                                    <option value="">Please Select a Language</option>
                                </select>
                            </div>

                            <span class="help-block">Select one or multiple language</span>
                        </div>
                        <span id="error_language" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label class="cols-sm-2 control-label">Name of the Movie:</label>
                        <div class="cols-sm-10">
                            <select disabled class="form-control" name="Movie" onchange="checkError('movie', 'error_movie');" id="movie">
                                <option value="">Please Select a Movie</option>
                            </select>
                        </div>
                        <span id="error_movie" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label class="cols-sm-2 control-label">Rating:</label>
                        <div class="cols-sm-10">
                            <input type="text" maxlength="1" class="form-control" onchange="checkError('rating', 'error_rating');" name="rating" id="rating"
                                   placeholder="Enter your rating here" />
                        </div>
                        <span id="error_rating" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label class="cols-sm-2 control-label">Review:</label>
                        <div class="cols-sm-10">
                            <textarea type="text" maxlength="1000" class="form-control" name="review" id="review" onchange="checkError('review', 'error_review');" style="height: 70px;" placeholder="Please leave your review here"></textarea>
                        </div>
                        <span id="error_review" class="text-danger"></span>
                    </div>
                    <div class="form-group ">
                        <button id="submit" type="button" class="btn btn-success" onclick="onSubmit()">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        async function getLanguages(){
            const response = await fetch('all-languages', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data?.data?.length) {
            const options = data.data.map(e=>{
                return `<option value="${e.id}">${e.name}</option>`
            });
                const select = document.getElementById("languages");
                data.data.forEach(e => {
                    const newOption = document.createElement('option');
                    const optionText = document.createTextNode(e.name);
                    newOption.appendChild(optionText);
                    newOption.setAttribute('value', e.id);
                    select.appendChild(newOption);
                });
            }
        }

        async function getGenres(){
            const response = await fetch('all-genres', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data?.data?.length) {
            const options = data.data.map(e=>{
                return `<option value="${e.id}">${e.name}</option>`
            });
                const select = document.getElementById("genres");
                data.data.forEach(e => {
                    const newOption = document.createElement('option');
                    const optionText = document.createTextNode(e.name);
                    newOption.appendChild(optionText);
                    newOption.setAttribute('value', e.id);
                    select.appendChild(newOption);
                });
            }
        }

        async function getMovies(genre, language){
            const response = await fetch(`get-movies?genre=${genre}&language=${language}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data?.data?.length) {
            const options = data.data.map(e=>{
                return `<option value="${e.id}">${e.name}</option>`
            });
                const select = document.getElementById("movie");
                data.data.forEach(e => {
                    const newOption = document.createElement('option');
                    const optionText = document.createTextNode(e.name);
                    newOption.appendChild(optionText);
                    newOption.setAttribute('value', e.id);
                    select.appendChild(newOption);
                });
            }
        }

        window.onload = async function () {
            getLanguages();
            getGenres();
        }
        var errorMessages = [
            { fieldName: "genres", errorText: "Please Select a Genre.", errorSpanName: 'error_genres' },
            { fieldName: "languages", errorText: "Please Select a language.", errorSpanName: 'error_language' },
            { fieldName: "movie", errorText: "Please Select a Movie.", errorSpanName: 'error_movie' },
            { fieldName: "rating", errorText: "Please Enter a rating.", errorSpanName: 'error_rating' },
            { fieldName: "review", errorText: "Please Enter a review.", errorSpanName: 'error_review' },
        ];

        function checkError(fieldName, errorSpanName, isSaveButtonClicked = false) {
                document.getElementById(errorSpanName).innerHTML = !document.getElementById(fieldName).value ? errorMessages.find(data => data.fieldName === fieldName)?.errorText : '';
                if((fieldName == "genres" || fieldName == "languages") && !isSaveButtonClicked){
                    const genres = document.getElementById("genres").value;
                    const language = document.getElementById("languages").value;
                    const movieElement = document.getElementById("movie");
                    movieElement.innerText = "";
                    movieElement.value = "";
                    const defaultOption = document.createElement('option');
                    const defaultOptionText = document.createTextNode("Please Select a Movie");
                    defaultOption.appendChild(defaultOptionText);
                    defaultOption.setAttribute('value', "");
                    movieElement.appendChild(defaultOption);
                    if(genres || language){
                        getMovies(genres, language);
                    }
                    if((genres || language) && movieElement.disabled){
                        movieElement.disabled = false;
                    } else if(!(genres || language)){
                        movieElement.value = "";
                        movieElement.disabled = true;
                    }
                } else if(fieldName == "rating" && !isSaveButtonClicked){
                    const rating = document.getElementById("rating");
                    if(isNaN(rating.value)){
                        rating.value = "";
                        checkError('rating', 'error_rating');
                    } else if(rating.value > 5 || rating.value < 0){
                        document.getElementById("error_rating").innerHTML = "Rating should be 0-5";
                    }
                }

        }
        async function onSubmit() {
            let value = {};
            errorMessages.forEach(data => {
                checkError(data.fieldName, data.errorSpanName, true);
            });
            const requestCheck = makeRequestBody();
            if (requestCheck.isValid) {
                const response = await fetch('review-movie', {
                    method: 'POST',
                    body: JSON.stringify(requestCheck.data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                const element = document.getElementById("response-message");
                element.className = `alert ${data.success ? 'alert-success' : 'alert-danger'}`;
                element.textContent = `${data.message || (data.success ? "Review Given successfully" : "Something went wrong")}`;
                setTimeout(()=>{
                        element.className = `alert`;
                        element.textContent = "";
                    }, 5000);
                if(data.success == 0){
                    if(data.error){
                        for (var key in data.error) {
                            errorSpanName = errorMessages.find(error => error.fieldName == key)?.errorSpanName;
                            if (errorSpanName) {
                                document.getElementById(errorSpanName).innerHTML = data.error[key];
                            }
                        }
                    }
                } else {
                    document.getElementById("genres").value = "";
                    document.getElementById("languages").value = "";
                    document.getElementById("movie").value = "";
                    document.getElementById("rating").value = "";
                    document.getElementById("review").value = "";
                }
            }
        }

        function makeRequestBody() {
            const movie = document.getElementById("movie").value;
            const review = document.getElementById("review").value;
            const rating = document.getElementById("rating").value;
            const genres = document.getElementById("genres").value;
            const languages = document.getElementById("languages").value;
            return {
                isValid: (movie && review && rating && genres && languages), data: {
                    movie, review, rating
                }
            };
        }
    </script>
</body>

</html>